<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>学生一覧</title>
</head>
<body>
<h1>学生一覧</h1>

<div style="background-color: #f5f5f5; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd;">
  <h3 style="margin-top: 0;">🔍 検索条件</h3>
  <form th:action="@{/students/search}" method="get">
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
      <div>
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">名前:</label>
        <input type="text" name="name" th:value="${searchName}"
               placeholder="部分一致で検索"
               style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">地域:</label>
        <input type="text" name="area" th:value="${searchArea}"
               placeholder="部分一致で検索"
               style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">コース名:</label>
        <select name="courseName" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">全て</option>
          <option value="Java入門" th:selected="${searchCourseName == 'Java入門'}">Java入門</option>
          <option value="Spring実践" th:selected="${searchCourseName == 'Spring実践'}">Spring実践</option>
          <option value="Webアプリ開発" th:selected="${searchCourseName == 'Webアプリ開発'}">Webアプリ開発</option>
        </select>
      </div>
      <div>
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">申込状況:</label>
        <select name="enrollmentStatus" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">全て</option>
          <option value="仮申込" th:selected="${searchEnrollmentStatus == '仮申込'}">仮申込</option>
          <option value="本申込" th:selected="${searchEnrollmentStatus == '本申込'}">本申込</option>
          <option value="受講中" th:selected="${searchEnrollmentStatus == '受講中'}">受講中</option>
          <option value="受講終了" th:selected="${searchEnrollmentStatus == '受講終了'}">受講終了</option>
        </select>
      </div>
    </div>
    <div style="display: flex; gap: 10px;">
      <button type="submit"
              style="padding: 10px 30px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
        検索
      </button>
      <a href="/studentList"
         style="padding: 10px 30px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px; display: inline-block; font-weight: bold;">
        クリア
      </a>
    </div>
  </form>
</div>

<!-- フラッシュメッセージ統一表示領域 -->
<div th:if="${successMessage}" th:text="${successMessage}"></div>
<div th:if="${errorMessage}" th:text="${errorMessage}"></div>

<form th:action="@{/student/delete}" method="post" onsubmit="return confirmAndDisable(this)">
  <table border="1">
    <thead>
    <tr>
      <th>ID</th>
      <th>名前</th>
      <th>カナ名</th>
      <th>ニックネーム</th>
      <th>メール</th>
      <th>地域</th>
      <th>年齢</th>
      <th>性別</th>
      <th>コース情報</th>
      <th>削除選択</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="studentDetail : ${studentList}">
      <td th:text="${studentDetail.student.id}">1</td>
      <td>
        <a th:href="@{/student/{id}/edit(id=${studentDetail.student.id})}"
           th:text="${studentDetail.student.name}">山田太郎</a>
      </td>
      <td th:text="${studentDetail.student.kanaName}">ヤマダタロウ</td>
      <td th:text="${studentDetail.student.nickname ?: '-'}">タロー</td>
      <td th:text="${studentDetail.student.email}">yamada@example.com</td>
      <td th:text="${studentDetail.student.area}">東京都</td>
      <td th:text="${studentDetail.student.age}">20</td>
      <td th:text="${studentDetail.student.sex}">男性</td>
      <td>
        <!-- 複数コース表示（指示書準拠） -->
        <div th:if="${studentDetail.hasCourses()}">
          <div th:each="course : ${studentDetail.StudentCourse}">
            <strong th:text="${course.courseName}">Java入門</strong><br>
            <span
                th:text="${#temporals.format(course.courseStartAt, 'yyyy/MM/dd')}">2024/04/01</span>
            ～
            <span th:text="${#temporals.format(course.courseEndAt, 'yyyy/MM/dd')}">2024/07/01</span>
            <br>
            <span style="color: #0066cc; font-weight: bold;"
                  th:text="'状況: ' + ${course.enrollmentStatus != null ? course.enrollmentStatus.status : '未設定'}">
              状況: 受講中
            </span>
          </div>
        </div>
        <span th:unless="${studentDetail.hasCourses()}">コースなし</span>
      </td>
      <td>
        <input type="radio" name="selectedId" th:value="${studentDetail.student.id}">
      </td>
    </tr>
    </tbody>
  </table>

  <div>
  </div>

  <div>
    <button type="submit">削除</button>
    <a href="/newStudent">新規登録</a>
    <a href="/courseList">コース一覧</a>
  </div>
</form>

<script>
  // 多重送信防止付きの確認処理（指示書準拠）
  function confirmAndDisable(form) {
    const selectedRadio = document.querySelector('input[name="selectedId"]:checked');
    if (!selectedRadio) {
      alert('削除する学生を選択してください');
      return false;
    }

    if (!confirm('選択した学生を削除しますか？')) {
      return false;
    }

    // 多重送信防止
    const submitButton = form.querySelector('button[type="submit"]');
    setTimeout(() => {
      submitButton.disabled = true;
      submitButton.textContent = '削除中...';
    }, 100);

    return true;
  }
</script>
</body>
</html>